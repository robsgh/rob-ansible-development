---
- hosts: localhost
  tasks:
  - name: Set resources for small vm
    set_fact:
      disk_size_gb: 12
      cpus: 2
      mem_mb: 2048
    when: vm_size == "small"

  - name: Set resources for medium vm
    set_fact:
      disk_size_gb: 64
      cpus: 4
      mem_mb: 4096
    when: vm_size == "medium"

  - name: Set resources for large vm
    set_fact:
      disk_size_gb: 96
      cpus: 6
      mem_mb: 8192
    when: vm_size == "large"

  - name: Create VM from template
    xenserver_guest:
      hostname: "{{ xenserver_host }}"
      password: "{{ xenserver_password }}"
      validate_certs: no
      name: "{{ vm_name }}"
      state: poweredon
      template: "{{ vm_template }}"
      linked_clone: yes
      disks:
      - size_gb: "{{ disk_size_gb }}"
        name: "{{ vm_name }} Disk 0"
        name_desc: "{{ vm_name }} Root disk 0. Autogenerated by Ansible AWX."
      hardware:
        num_cpus: "{{ cpus }}" 
        num_cpu_cores_per_socket: 1
        memory_mb: "{{ mem_mb }}"
      cdrom:
        type: none
      networks:
      - name: d501-server-prod
      wait_for_ip_address: yes
    delegate_to: localhost
    register: deploy

  - name: Set application tag
    include_role:
      name: xen-tags
    vars:
      vm_add_tag: "{{ vm_tag }}"
